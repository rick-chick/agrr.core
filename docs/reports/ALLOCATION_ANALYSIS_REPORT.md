# 作物配分最適化の「期間不足」問題 - 調査レポート

## 概要

`agrr optimize allocate` コマンドを実行した際の「期間不足」問題について調査を行いました。

## 調査対象データ

- **作物**: キュウリ（白イボ）
- **圃場**: Field-baaad936（25.0 m²）
- **天気データ期間**: 2025年1月1日 〜 2026年12月29日（725日間）
- **計画期間**: 2025年1月1日 〜 2026年12月29日

## 調査結果

### 1. 「期間不足」問題は存在しない

**重要な発見:**
- 評価された候補数: **199個**
- 有効な候補（完了可能）: **199個（100%）**
- 無効な候補（完了不可能）: **0個**

→ **すべての開始日候補で栽培が完了可能です。「期間不足」という問題は実際には発生していません。**

### 2. 最適な栽培期間

```
開始日: 2025年6月5日
完了日: 2026年7月18日
栽培日数: 409日
```

### 3. なぜ409日もかかるのか

#### 作物要件（キュウリ）
- 育苗期: 300 GDD（度日）
- 定植期: 300 GDD
- 生育期: 800 GDD
- 収穫期: 800 GDD
- **合計: 2200 GDD**
- **基準温度: 10.0°C**

#### 天気データの分析
```
総日数: 725日
有効日数（10°C超）: 318日（43.9%）
平均GDD/日: 4.05度日
推定必要日数: 544日
```

#### 問題の本質

1. **基準温度が高い**
   - 基準温度10°Cを設定しているため、冬季（1月〜3月、12月）は全くGDDが蓄積されない
   - 1年のうち、有効な日数は約44%のみ

2. **冬季の影響**
   - 天気データを見ると、1月の気温は最高でも6℃程度、最低は-6℃程度
   - この地域（緯度40.8244、経度140.74 = 青森県付近）では、冬季が非常に寒い

3. **平均GDD/日が非常に低い**
   - 平均4.05度日/日では、2200度日を達成するには544日必要
   - しかし、評価期間が725日あるため、完了は可能

4. **最適な開始日が6月5日になる理由**
   - 冬季を避けて暖かい時期（5月〜10月）にGDDを蓄積
   - 1年目の夏季（2025年6月〜10月）+ 2年目の夏季（2026年4月〜7月）でようやく達成

## 候補例（最初の5つ）

| 開始日 | 完了日 | 栽培日数 |
|--------|--------|---------|
| 2025-06-05 | 2026-07-18 | 409日 |
| 2025-06-06 | 2026-07-19 | 409日 |
| 2025-06-07 | 2026-07-20 | 409日 |
| 2025-06-14 | 2026-07-27 | 409日 |
| 2025-06-15 | 2026-07-28 | 409日 |

## 推奨される対策

### 1. 基準温度の見直し

キュウリの基準温度を10°Cから下げることを検討：

```json
"base_temperature": 8.0  // または7.0
```

一般的に：
- キュウリの生育最低温度: 約8-10°C
- より低い基準温度を設定すれば、より多くの日でGDDが蓄積される

### 2. GDD要件の見直し

現在の合計2200度日は、この地域には厳しすぎる可能性があります：

```json
// 現在
"育苗期": 300 GDD
"定植期": 300 GDD
"生育期": 800 GDD
"収穫期": 800 GDD

// 推奨（例）
"育苗期": 200 GDD  // -100
"定植期": 250 GDD  // -50
"生育期": 600 GDD  // -200
"収穫期": 600 GDD  // -200
// 合計: 1650 GDD (-550 GDD、25%削減)
```

### 3. 栽培地域の確認

緯度40.8244、経度140.74（青森県付近）は寒冷地です。以下のいずれかを検討：

- **ハウス栽培の考慮**: ハウス内の温度データを使用
- **栽培時期の制限**: 夏季（4月〜10月）のみの栽培期間を設定
- **耐寒性品種の選択**: より低温に強い品種の作物プロファイルを使用

### 4. 計画期間の調整

より長い計画期間を設定：

```bash
# 現在
--planning-start 2025-01-01 --planning-end 2026-12-29

# 推奨: 3年分の天気データを用意
--planning-start 2025-01-01 --planning-end 2027-12-31
```

## 結論

**「期間不足」という問題は発生していません。**

実際の問題は：
1. **基準温度10°Cが寒冷地には高すぎる**
2. **GDD要件2200度日が厳しすぎる**
3. **結果として栽培日数が409日と長くなっている**

最適化アルゴリズムは正常に動作しており、すべての候補を評価して最適な開始日を選定しています。

ユーザーが期待する栽培期間（例: 90〜120日）にするには、作物プロファイル（基準温度やGDD要件）の見直しが必要です。

## テストコマンド

デバッグ情報を確認するスクリプトを作成しました：

```bash
python3 debug_allocation.py
```

このスクリプトは以下の情報を表示します：
- 必要なGDD
- 有効日数
- 平均GDD/日
- 候補の有効/無効カウント
- 最適な栽培期間

## 🚨 重大な問題: 天気予測データの妥当性

### 現状の問題

**現在日付**: 2025年10月14日

**天気データ期間**: 2025年1月1日 〜 2026年12月29日（728日間）

#### データの内訳
- **過去データ**: 2025年1月1日 〜 10月14日（286日分）
- **未来の予測データ**: 2025年10月15日 〜 2026年12月29日（**441日分 ≈ 14.7ヶ月**）

### 評価: ❌❌ 使用不可

**約1.2年先の日単位天気予測は科学的に不可能です。**

#### 天気予測の種類と精度

| 予測種類 | 期間 | 精度 | 備考 |
|---------|------|------|------|
| 短期予報 | 3〜7日 | 高い（80-90%） | 日単位の温度・降水量が信頼できる |
| 中期予報 | 8〜14日 | 中程度（60-70%） | 精度は徐々に低下 |
| 1ヶ月予報 | 15〜30日 | 低い（40-50%） | 気温傾向のみ、降水量は不確実 |
| 3ヶ月予報 | 31〜90日 | 非常に低い | 統計的傾向のみ |
| 季節予報 | 91〜180日 | 極めて低い | 「暖冬」「多雨」などの傾向のみ |
| **本データ** | **441日** | **不可能** | **日単位予測は無意味** |

### 推奨される解決策

#### 1. 過去の実データを使用（最推奨）

作物配分の最適化には、**過去の同時期の気候データ**を使用するのが標準的です：

```bash
# 2024年の実データを取得
agrr weather --location 40.8244,140.74 \
  --start-date 2024-01-01 --end-date 2024-12-31 \
  --json > weather_2024_actual.json

# 複数年の平均を使う（より安定）
agrr weather --location 40.8244,140.74 \
  --start-date 2023-01-01 --end-date 2023-12-31 \
  --json > weather_2023_actual.json

# 2年分のデータを平均化して使用
```

**理由**:
- 気候は年ごとに類似パターンを持つ
- 過去データは実測値なので信頼性が高い
- 農業計画では「平年値」を使うのが標準

#### 2. 気候平年値を使用

```bash
# 過去30年の平均データ（気象庁など）
# Open-Meteo Climate APIなどを使用
```

#### 3. シナリオ分析

複数の気候シナリオで計画を評価：
- 標準シナリオ（平年値）
- 暖冬シナリオ（+2℃）
- 厳冬シナリオ（-2℃）
- 多雨シナリオ
- 少雨シナリオ

#### 4. 短期予測の場合のみARIMA使用

```bash
# 最大でも30-90日程度
agrr predict --input historical.json --output predictions.json --days 30
```

ただし、これも傾向把握のみで、日単位の正確な予測は期待できません。

### 本システムへの影響

#### 現在の最適化結果の問題点

1. **409日間の栽培計画**（2025年6月5日〜2026年7月18日）のうち、
   - 2025年10月15日以降のデータは**予測として無効**
   - つまり、計画の大部分が信頼できないデータに基づいている

2. **収益・コスト計算が不正確**
   - 実際の天気が予測と異なれば、GDD蓄積速度が変わる
   - 栽培期間が大幅に変わる可能性

3. **リスク評価ができない**
   - 天気の不確実性が考慮されていない
   - 「最悪ケース」「最良ケース」の幅が分からない

### システム改善提案

#### A. データソースの変更（実装レベル）

```python
# 現在: 未来予測データを使用（不適切）
weather_data = get_forecast(start_date, end_date)

# 推奨: 過去の同時期データを使用
weather_data = get_historical_same_period(
    target_year=2024,  # または複数年の平均
    period_start="01-01",
    period_end="12-31"
)
```

#### B. CLI使用方法の改善（ユーザーレベル）

```bash
# ❌ 間違った使い方（未来予測を使用）
agrr forecast --location 40.8244,140.74 > forecast.json
agrr optimize allocate --weather-file forecast.json ...

# ✅ 正しい使い方（過去実データを使用）
agrr weather --location 40.8244,140.74 \
  --start-date 2024-01-01 --end-date 2024-12-31 \
  --json > weather_2024_actual.json

agrr optimize allocate \
  --weather-file weather_2024_actual.json \
  --fields-file fields.json \
  --crops-file crops.json \
  --planning-start 2026-01-01 \
  --planning-end 2026-12-31
  # ↑ 2026年の計画に2024年の気候パターンを適用
```

#### C. 不確実性を考慮した最適化（将来機能）

```bash
# シナリオ分析機能の追加
agrr optimize allocate \
  --weather-scenarios "normal,warm,cold" \
  --risk-analysis
```

### まとめ

現在の天気データ（2025-2026年）は：
1. **予測データとしては使用不可**（14.7ヶ月先は予測不可能）
2. **過去の実データに置き換えるべき**（2023-2024年の実測値）
3. **気候の不確実性を考慮したリスク分析が必要**

この問題は、最適化アルゴリズムの問題ではなく、**入力データの選択の問題**です。

## 関連ファイル

- **📊 天気予測精度検証レポート**: `WEATHER_FORECAST_VALIDATION_REPORT.md`（←**重要**）
- 作物データ: `test_data/crops_1760421725.json`
- 圃場データ: `test_data/fields_1760421725.json`
- 天気データ: `test_data/optimization_weather_1760421725.json`

---

## 📌 最終結論（天気予測精度検証後）

実測データとの比較により、以下が判明しました：

### ✅ 良いニュース

**過去期間（287日）の予測精度は良好**:
- 気温誤差: MAE=1.08°C（実用レベル）
- GDD累積誤差: +7.2%

### ⚠️ 注意すべき点

**系統的な暖かめバイアス**:
- 平均+0.81°C高く予測
- 結果として**栽培日数を23日短く見積もる**
- 409日の予測 → 実際は432日の可能性

### 🚨 重大な問題

**未来期間（441日、14.7ヶ月）の信頼性**:
- 過去の精度は保証されない
- 推定GDD誤差: ±10-20%
- **栽培日数の不確実性: ±40-90日**

---

## 🎯 最終推奨事項（優先順位順）

### 1️⃣ 最優先：過去の実測データを使用

```bash
# 2024年の実測データ（推奨）
agrr weather --location 40.8244,140.74 \
  --start-date 2024-01-01 --end-date 2024-12-31 \
  --json > weather_2024_actual.json

# これを使って2026年の計画を立てる
agrr optimize allocate \
  --weather-file weather_2024_actual.json \
  --fields-file fields.json \
  --crops-file crops.json \
  --planning-start 2026-01-01 --planning-end 2026-12-31
```

### 2️⃣ 作物プロファイルの調整

寒冷地（青森県）に適した設定:

```json
{
  "base_temperature": 8.0,  // 10.0から下げる
  "育苗期": 200,  // 300から削減
  "定植期": 250,  // 300から削減
  "生育期": 600,  // 800から削減
  "収穫期": 600   // 800から削減
}
```

### 3️⃣ 複数シナリオ分析（将来機能）

- 標準シナリオ（平年値）
- 暖冬シナリオ（+2°C）
- 厳冬シナリオ（-2°C）

---

## 📈 影響の定量化

| 項目 | 現在の予測 | 実測ベース推定 | 差 |
|------|----------|----------------|-----|
| 栽培日数 | 409日 | 432日 | +23日 |
| 固定費 | ¥51,125 | ¥54,000 | +¥2,875 |
| 利益 | ¥-31,125 | ¥-33,875 | -¥2,750 |

**不確実性の幅**（未来期間の予測誤差含む）:
- 栽培日数: 390〜500日（±90日）
- 固定費: ¥48,750〜¥62,500
- 利益: ¥-42,500〜¥-28,750

---

**詳細は `WEATHER_FORECAST_VALIDATION_REPORT.md` を参照してください。**

