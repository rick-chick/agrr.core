# 必須カラムの仕様 - 簡易サマリー

## TL;DR（要約）

**必須**: 気温のみ（mean, max, min のいずれか1つ）  
**オプション**: 降水量、日照、湿度、風速など全て

---

## 処理フロー

```
JMAから1行のデータを取得
    ↓
┌─────────────────────────────────────────┐
│ Step 1: カラム数チェック                │
│  len(cells) >= 9 ?                      │
│  (気温データにアクセスできるか)         │
└─────────────────────────────────────────┘
    ↓ YES
┌─────────────────────────────────────────┐
│ Step 2: 日付チェック                    │
│  cells[0] が有効な日付?                 │
└─────────────────────────────────────────┘
    ↓ YES
┌─────────────────────────────────────────┐
│ Step 3: 気温チェック（唯一の必須）      │
│  temp_mean OR temp_max OR temp_min      │
│  が Not None ?                          │
└─────────────────────────────────────────┘
    ↓ YES                    ↓ NO
   ✅ 有効                  ❌ 無効（スキップ）
    ↓
データを返却（降水量や日照がNoneでもOK）
```

---

## 具体例

### ケース1: 完全なデータ
```python
cells = ['1', ..., '0.0', ..., '6.4', '10.5', '2.3', ..., '5.2']
         日      降水量    平均   最高    最低      日照

日付: ✅  気温: ✅  降水量: ✅  日照: ✅
→ ✅ 有効（取得）
```

### ケース2: 降水量欠損（これもOK！）
```python
cells = ['2', ..., None,  ..., '7.2', '11.2', '3.1', ..., '4.8']
         日      降水量    平均   最高    最低      日照

日付: ✅  気温: ✅  降水量: ❌  日照: ✅
→ ✅ 有効（取得）← **降水量Noneでも気温があるのでOK**
```

### ケース3: 日照欠損（これもOK！）
```python
cells = ['3', ..., '1.5', ..., '8.5', '12.0', '4.0', ..., None]
         日      降水量    平均   最高    最低      日照

日付: ✅  気温: ✅  降水量: ✅  日照: ❌
→ ✅ 有効（取得）← **日照Noneでも気温があるのでOK**
```

### ケース4: 気温欠損（これはNG）
```python
cells = ['4', ..., '2.5', ..., None, None, None, ..., '3.1']
         日      降水量    平均  最高   最低      日照

日付: ✅  気温: ❌  降水量: ✅  日照: ✅
→ ❌ 無効（スキップ）← **気温が全くないのでNG**
```

### ケース5: カラム数不足
```python
cells = ['5', '1013.0', '1023.0', '0.0']  # 4個しかない
         日    気圧      気圧     降水量
         
len(cells) = 4 < 9（cells[6-8]の気温にアクセス不可）
→ ❌ 無効（スキップ）← **気温データを取得できない**
```

### ケース6: 降水量と日照が両方欠損（これもOK！）
```python
cells = ['6', ..., None, ..., '9.0', '13.5', '5.5', ..., None]
         日      降水量    平均   最高    最低      日照

日付: ✅  気温: ✅  降水量: ❌  日照: ❌
→ ✅ 有効（取得）← **気温さえあればOK**
```

---

## なぜ気温だけ必須なのか？

### 理由1: GDD（成長度日）計算に必須
```python
# 成長度日の計算
def calculate_gdd(temperature_mean, base_temperature=10.0):
    return max(0, temperature_mean - base_temperature)

# 気温がないと計算不可
calculate_gdd(None, 10.0)  # ← エラー！
```

### 理由2: 作物の成長予測の核心
- **気温**: 作物の成長速度を決定（最重要）
- 降水量: 水やりで補える
- 日照: ある程度予測可能
- 湿度: 重要度が相対的に低い

### 理由3: データの実用性
```python
# 気温があれば基本的な予測が可能
if temperature_data_available:
    growth_days = calculate_growth_period(temperature)  # OK
    planting_date = optimize_planting_date(temperature)  # OK

# 降水量や日照は補助的
if precipitation_data_available:
    irrigation_plan = optimize_irrigation(precipitation)  # Better
```

---

## 実装時の判定ロジック

```python
def is_row_valid_for_agriculture(row: TableRow) -> bool:
    """
    農業予測に使用できる行かを判定
    
    Returns:
        True: 気温データが少なくとも1つある
        False: 気温データが全くない
    """
    # カラム数チェック
    if len(row.cells) < 9:
        return False  # 気温カラムにアクセスできない
    
    # 日付チェック
    if not is_valid_date(row.cells[0]):
        return False
    
    # 気温チェック（これが本質）
    temp_mean = safe_float(row.cells[6])
    temp_max = safe_float(row.cells[7])
    temp_min = safe_float(row.cells[8])
    
    # 気温が1つでもあれば有効
    has_temperature = (
        temp_mean is not None or 
        temp_max is not None or 
        temp_min is not None
    )
    
    return has_temperature  # ← これだけが判定基準
    
    # 降水量、日照、湿度はチェックしない（Noneでも有効）
```

---

## データ取得の実例

### 入力: 2024年1月の31日分のHTMLテーブル

```
Day | 気温 | 降水量 | 日照 | 風速 | 判定
----|------|--------|------|------|------
 1  |  ✅  |  ✅   |  ✅  |  ✅  | ✅ 有効（完全）
 2  |  ✅  |  ✅   |  ✅  |  ❌  | ✅ 有効（風速Noneだが気温あり）
 3  |  ✅  |  ❌   |  ✅  |  ✅  | ✅ 有効（降水量Noneだが気温あり）
 4  |  ❌  |  ✅   |  ✅  |  ✅  | ❌ 無効（気温なし）
 5  |  ✅  |  ❌   |  ❌  |  ❌  | ✅ 有効（気温のみ）
...
31  |  ✅  |  ✅   |  ✅  |  ✅  | ✅ 有効（完全）
```

**結果**: 
- 取得: 29日分（Day 4のみスキップ）
- 気温: 全データで保証
- 降水量: 一部None
- 日照: 一部None
- 風速: 一部None

**使用可能な分析**:
- ✅ GDD計算（気温必須）
- ✅ 成長期間予測（気温必須）
- ✅ 最適播種日（気温必須）
- ⚠️ 灌漑計画（降水量あると良い）
- ⚠️ 日照評価（日照あると良い）

---

## まとめ

### 「無効」とする条件（2つだけ）

1. ❌ **日付がない** - 何のデータか不明
2. ❌ **気温が全くない** - GDD計算不可

### 「有効」とする条件（1つだけ）

✅ **日付があり、気温が少なくとも1つある**

→ 降水量、日照、湿度、風速などは**全て欠損していてもOK**

### この仕様の利点

1. ✅ **シンプル** - 判定基準が明確
2. ✅ **実用的** - 気温さえあれば農業予測の基本ができる
3. ✅ **柔軟** - データ取得量を最大化
4. ✅ **バランス** - 品質と実用性のバランスが良い


