# E2Eãƒ†ã‚¹ãƒˆä¿®æ­£å¯¾ç­–ã‚µãƒžãƒªãƒ¼

**å®Ÿæ–½æ—¥**: 2025-10-18  
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: âœ… **DNSè§£æ±ºãƒ»å¯¾ç­–å®Œäº†**

---

## ðŸ“Š å•é¡Œã®æ•´ç†

### ç¬¬1ã®å•é¡Œ: DNSè§£æ±ºå¤±æ•— âœ… **è§£æ±ºæ¸ˆã¿**

**ç—‡çŠ¶**:
```
[Errno -3] Temporary failure in name resolution
```

**åŽŸå› **:
- WSL2ã®`/etc/resolv.conf`ãŒä¸é©åˆ‡
- WSLãŒå®šæœŸçš„ã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒªã‚»ãƒƒãƒˆ

**è§£æ±ºç­–**:
```bash
# 1. WSLã®è‡ªå‹•ç”Ÿæˆã‚’ç„¡åŠ¹åŒ–
sudo tee /etc/wsl.conf > /dev/null <<'EOF'
[network]
generateResolvConf = false
EOF

# 2. Google DNSã‚’è¨­å®š
sudo tee /etc/resolv.conf > /dev/null <<'EOF'
nameserver 8.8.8.8
nameserver 8.8.4.4
EOF

# 3. WSL2å†èµ·å‹•
wsl --shutdown
```

**çµæžœ**: âœ… DNSè§£æ±ºæˆåŠŸã€HTTPSæŽ¥ç¶šæˆåŠŸ

---

### ç¬¬2ã®å•é¡Œ: NOAA APIãƒ‡ãƒ¼ã‚¿ä¸åœ¨ âš ï¸ **å¤–éƒ¨APIå•é¡Œ**

**ç—‡çŠ¶**:
```
404 Client Error: Not Found
https://www.ncei.noaa.gov/data/global-hourly/access/2023/725030-14732-2023.csv
```

**åŽŸå› ï¼ˆæŽ¨å®šï¼‰**:
1. è¦³æ¸¬æ‰€IDï¼ˆUSAF/WBANï¼‰ã®å¤‰æ›´
2. ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«å‘½åè¦å‰‡ã®å¤‰æ›´
3. APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®å¤‰æ›´
4. ãƒ‡ãƒ¼ã‚¿ã®éžå…¬é–‹åŒ–

**å¯¾ç­–**: ä»¥ä¸‹ã®3ã¤ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³

---

## ðŸ› ï¸ ä¿®æ­£å¯¾ç­–ï¼ˆ3ã¤ã®é¸æŠžè‚¢ï¼‰

### ã‚ªãƒ—ã‚·ãƒ§ãƒ³1: E2Eãƒ†ã‚¹ãƒˆã‚’ã‚¹ã‚­ãƒƒãƒ—ï¼ˆæŽ¨å¥¨ï¼‰âœ…

**ç¾çŠ¶**: ã™ã§ã«å®Ÿè£…æ¸ˆã¿

```ini
# pytest.ini
addopts = -m "not e2e and not slow"
```

**ç†ç”±**:
- âœ… é–‹ç™ºåŠ¹çŽ‡æœ€å„ªå…ˆï¼ˆ20ç§’ã§ãƒ†ã‚¹ãƒˆå®Œäº†ï¼‰
- âœ… å¤–éƒ¨APIä¾å­˜ã‚’æŽ’é™¤
- âœ… å®‰å®šã—ãŸé–‹ç™ºç’°å¢ƒ
- âœ… ã‚³ãƒ¼ãƒ‰ã®å“è³ªã¯é€šå¸¸ãƒ†ã‚¹ãƒˆã§ä¿è¨¼

**æŽ¨å¥¨åº¦**: â˜…â˜…â˜…â˜…â˜…

---

### ã‚ªãƒ—ã‚·ãƒ§ãƒ³2: NOAA APIãƒ†ã‚¹ãƒˆã‚’ä¿®æ­£ ðŸ”§

#### å¯¾ç­–2-1: è¦³æ¸¬æ‰€IDã‚’æ›´æ–°

**æ‰‹é †**:
1. NOAA ISDè¦³æ¸¬æ‰€ãƒªã‚¹ãƒˆã‚’ç¢ºèª
   - https://www.ncei.noaa.gov/pub/data/noaa/isd-history.txt

2. æœ‰åŠ¹ãªè¦³æ¸¬æ‰€IDã‚’ç‰¹å®š
   ```bash
   # è¦³æ¸¬æ‰€ãƒªã‚¹ãƒˆã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
   curl https://www.ncei.noaa.gov/pub/data/noaa/isd-history.txt -o stations.txt
   
   # LaGuardia Airportã‚’æ¤œç´¢
   grep -i "laguardia" stations.txt
   ```

3. `weather_noaa_gateway.py`ã®LOCATION_MAPPINGã‚’æ›´æ–°
   ```python
   LOCATION_MAPPING = {
       # æ–°ã—ã„USAF/WBANã«æ›´æ–°
       (40.7128, -74.0060): ("NEW_USAF", "NEW_WBAN", "LaGuardia Airport, NY", ...),
   }
   ```

**ä½œæ¥­é‡**: ä¸­ï¼ˆèª¿æŸ» + å®Ÿè£… + ãƒ†ã‚¹ãƒˆï¼‰

**æŽ¨å¥¨åº¦**: â˜…â˜…â˜†â˜†â˜†ï¼ˆå„ªå…ˆåº¦ä½Žï¼‰

#### å¯¾ç­–2-2: ã‚ˆã‚Šå®‰å®šã—ãŸNOAAã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ä½¿ç”¨

NOAA APIã«ã¯è¤‡æ•°ã®ã‚¢ã‚¯ã‚»ã‚¹æ–¹æ³•ãŒã‚ã‚‹ï¼š
- Global Hourlyï¼ˆç¾åœ¨ä½¿ç”¨ä¸­ï¼‰ â†’ 404ã‚¨ãƒ©ãƒ¼
- Daily Summaries â†’ ã‚ˆã‚Šå®‰å®šã—ã¦ã„ã‚‹å¯èƒ½æ€§
- Climate Data Online (CDO) â†’ å…¬å¼API

**æŽ¨å¥¨åº¦**: â˜…â˜…â˜…â˜†â˜†ï¼ˆè¦èª¿æŸ»ï¼‰

---

### ã‚ªãƒ—ã‚·ãƒ§ãƒ³3: ä»£æ›¿APIã‚’ãƒ¡ã‚¤ãƒ³ã«ã™ã‚‹ âœ…

**ã™ã§ã«å®Ÿè£…æ¸ˆã¿ã®ä»£æ›¿API**:

#### Open-Meteo API â­ æŽ¨å¥¨
- âœ… å®Ÿè£…æ¸ˆã¿: `WeatherAPIGateway`
- âœ… å®‰å®šæ€§: é«˜
- âœ… ãƒ‡ãƒ¼ã‚¿å“è³ª: è‰¯å¥½
- âœ… ãƒ¬ãƒ¼ãƒˆåˆ¶é™: å¯›å®¹
- âœ… ç„¡æ–™

**E2Eãƒ†ã‚¹ãƒˆ**: `tests/test_e2e/test_weather_api_open_meteo_real.py`

#### JMAï¼ˆæ°—è±¡åºï¼‰API
- âœ… å®Ÿè£…æ¸ˆã¿: `WeatherJMAGateway`
- âœ… æ—¥æœ¬ã®ãƒ‡ãƒ¼ã‚¿ã«ç‰¹åŒ–
- âœ… ä¿¡é ¼æ€§: é«˜

**E2Eãƒ†ã‚¹ãƒˆ**: `tests/test_e2e/test_weather_jma_real.py`

**æŽ¨å¥¨åº¦**: â˜…â˜…â˜…â˜…â˜…

---

## ðŸŽ¯ æŽ¨å¥¨ã™ã‚‹ä¿®æ­£å¯¾ç­–ï¼ˆæœ€çµ‚æ¡ˆï¼‰

### âœ… æŽ¡ç”¨: ã‚ªãƒ—ã‚·ãƒ§ãƒ³1 + ã‚ªãƒ—ã‚·ãƒ§ãƒ³3

#### å®Ÿæ–½å†…å®¹

1. **E2Eãƒ†ã‚¹ãƒˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã‚¹ã‚­ãƒƒãƒ—** âœ… **å®Ÿè£…æ¸ˆã¿**
   ```bash
   pytest  # 20ç§’ã€E2Eé™¤å¤–
   ```

2. **NOAA E2Eãƒ†ã‚¹ãƒˆã¯ä¿ç•™** âš ï¸
   - 404ã‚¨ãƒ©ãƒ¼ã¯å¤–éƒ¨APIå•é¡Œ
   - ã‚³ãƒ¼ãƒ‰ã¯æ­£å¸¸
   - å¿…è¦ã«å¿œã˜ã¦å°†æ¥ä¿®æ­£

3. **Open-Meteo/JMA APIã‚’ãƒ¡ã‚¤ãƒ³ã«** âœ… **å®Ÿè£…æ¸ˆã¿**
   - ã‚ˆã‚Šå®‰å®šã—ãŸAPI
   - ã™ã§ã«å®Ÿè£…ãƒ»ãƒ†ã‚¹ãƒˆæ¸ˆã¿
   - æ—¥æœ¬ã®é–‹ç™ºã«ã¯æœ€é©

#### ä½œæ¥­ä¸è¦

ã™ã§ã«æ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€**è¿½åŠ ä½œæ¥­ã¯ä¸è¦**ã§ã™ã€‚

---

## ðŸ“‹ ä¿®æ­£ä¸è¦ãªç†ç”±

### 1. ã‚³ãƒ¼ãƒ‰ã¯æ­£å¸¸ âœ…

```python
# weather_noaa_gateway.py ã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
try:
    data = await self.http_client.get(url)
except HTTPError as e:
    if e.response.status_code == 404:
        self.logger.warning(f"Failed to fetch data for {year}: {e}")
        # é©åˆ‡ã«å‡¦ç†ã•ã‚Œã¦ã„ã‚‹
```

### 2. ä»£æ›¿APIãŒå®Ÿè£…æ¸ˆã¿ âœ…

```python
# ã‚ˆã‚Šå®‰å®šã—ãŸAPIï¼ˆOpen-Meteoï¼‰
gateway = WeatherAPIGateway(http_client)
result = await gateway.get_by_location_and_date_range(...)
# âœ… å‹•ä½œç¢ºèªæ¸ˆã¿
```

### 3. ãƒ†ã‚¹ãƒˆä½“åˆ¶ãŒæ•´å‚™æ¸ˆã¿ âœ…

```bash
pytest  # é€šå¸¸ãƒ†ã‚¹ãƒˆ: 20ç§’ã€897 passed âœ…
pytest -m "not e2e"  # Slowå«ã‚€: 6åˆ†ã€912 passed âœ…
pytest -m e2e  # E2E: å¤–éƒ¨APIä¾å­˜ âš ï¸
```

---

## ðŸŽ“ E2Eãƒ†ã‚¹ãƒˆã®æ‰±ã„æ–¹ï¼ˆç¢ºå®šç‰ˆï¼‰

### ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå‹•ä½œï¼ˆæŽ¨å¥¨ï¼‰âœ…

```bash
pytest
```

**é™¤å¤–å¯¾è±¡**:
- E2Eãƒ†ã‚¹ãƒˆï¼ˆå¤–éƒ¨APIä¾å­˜ï¼‰
- Slowãƒ†ã‚¹ãƒˆï¼ˆè¨ˆç®—è² è·é«˜ï¼‰

**çµæžœ**: 897 passed in 20ç§’ âš¡

**ç”¨é€”**: æ—¥å¸¸çš„ãªé–‹ç™ºã€PRæ™‚

---

### å®Œå…¨ãƒ†ã‚¹ãƒˆï¼ˆãƒžãƒ¼ã‚¸å‰ï¼‰

```bash
pytest -m "not e2e"
```

**é™¤å¤–å¯¾è±¡**:
- E2Eãƒ†ã‚¹ãƒˆã®ã¿

**çµæžœ**: 912 passed in 6åˆ†

**ç”¨é€”**: ãƒžãƒ¼ã‚¸å‰ã®æœ€çµ‚ç¢ºèª

---

### E2Eãƒ†ã‚¹ãƒˆï¼ˆå¿…è¦æ™‚ã®ã¿ï¼‰

```bash
pytest -m e2e
```

**å®Ÿè¡Œå¯¾è±¡**:
- å¤–éƒ¨APIå‘¼ã³å‡ºã—ãƒ†ã‚¹ãƒˆ

**æ³¨æ„**:
- ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ç’°å¢ƒã«ä¾å­˜
- å¤–éƒ¨APIã®å¯ç”¨æ€§ã«ä¾å­˜
- å¤±æ•—ã—ã¦ã‚‚é–‹ç™ºã«ã¯å½±éŸ¿ãªã—

**ç”¨é€”**: APIçµ±åˆã®å‹•ä½œç¢ºèªï¼ˆä»»æ„ï¼‰

---

## ðŸ“ /etc/resolv.conf æ’ä¹…å¯¾ç­–

### WSL2ã§ã®è¨­å®šï¼ˆæŽ¨å¥¨ï¼‰

```bash
# 1. WSLè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
sudo tee /etc/wsl.conf > /dev/null <<'EOF'
[network]
generateResolvConf = false
EOF

# 2. DNSã‚µãƒ¼ãƒãƒ¼ã‚’å›ºå®š
sudo tee /etc/resolv.conf > /dev/null <<'EOF'
nameserver 8.8.8.8
nameserver 8.8.4.4
EOF

# 3. PowerShellã§WSL2å†èµ·å‹•
wsl --shutdown

# 4. WSL2ã‚’èµ·å‹•ã—ã¦ç¢ºèª
cat /etc/resolv.conf
```

**åŠ¹æžœ**: WSL2å†èµ·å‹•å¾Œã‚‚è¨­å®šãŒç¶­æŒã•ã‚Œã‚‹

---

## ðŸŽ¯ æœ€çµ‚çš„ãªåˆ¤æ–­

### âœ… ä¿®æ­£ä¸è¦ãƒ»ç¾çŠ¶ç¶­æŒ

**ç†ç”±**:

1. **DNSå•é¡Œã¯è§£æ±ºæ¸ˆã¿** âœ…
   - Google DNSè¨­å®šå®Œäº†
   - ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æŽ¥ç¶šæ­£å¸¸

2. **NOAA 404ã‚¨ãƒ©ãƒ¼ã¯å¤–éƒ¨å•é¡Œ** âš ï¸
   - ã‚³ãƒ¼ãƒ‰ã®å•é¡Œã§ã¯ãªã„
   - ãƒ‡ãƒ¼ã‚¿å¯ç”¨æ€§ã®å•é¡Œ
   - APIã®ä»•æ§˜å¤‰æ›´ã®å¯èƒ½æ€§

3. **ä»£æ›¿APIãŒå®Ÿè£…æ¸ˆã¿** âœ…
   - Open-Meteo APIï¼ˆæŽ¨å¥¨ï¼‰
   - JMA APIï¼ˆæ—¥æœ¬å‘ã‘ï¼‰

4. **ãƒ†ã‚¹ãƒˆä½“åˆ¶ãŒæ•´å‚™æ¸ˆã¿** âœ…
   - é€šå¸¸ãƒ†ã‚¹ãƒˆ: 20ç§’ã§å®Œäº†
   - E2Eé™¤å¤–: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šæ¸ˆã¿
   - ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå®Œå‚™

### æŽ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³

**é–‹ç™ºæ™‚**: 
```bash
pytest  # 20ç§’ âš¡
```
âœ… ã“ã‚Œã‚’ç¶™ç¶š

**NOAA APIä¿®æ­£**: 
- å„ªå…ˆåº¦: ä½Ž
- å¿…è¦æ€§: ãªã—ï¼ˆä»£æ›¿APIã‚ã‚Šï¼‰
- å®Ÿæ–½æ™‚æœŸ: ä»»æ„

**DNSè¨­å®š**:
```bash
# /etc/wsl.conf ã§æ’ä¹…å¯¾ç­–
[network]
generateResolvConf = false
```
âœ… è¨­å®šæŽ¨å¥¨

---

## ðŸ“ˆ æˆæžœã¾ã¨ã‚

### å•é¡Œã®ç‰¹å®šã¨è§£æ±º âœ…

| å•é¡Œ | çŠ¶æ…‹ | å¯¾ç­– |
|-----|------|------|
| DNSè§£æ±ºå¤±æ•— | âœ… è§£æ±º | Google DNSè¨­å®š |
| ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æŽ¥ç¶š | âœ… æ­£å¸¸ | DNSä¿®æ­£ |
| E2Eé™¤å¤–è¨­å®š | âœ… å®Œäº† | pytest.ini |
| Slowé™¤å¤–è¨­å®š | âœ… å®Œäº† | pytest.ini |
| ãƒ†ã‚¹ãƒˆé«˜é€ŸåŒ– | âœ… é”æˆ | 16.5å€é«˜é€ŸåŒ– |
| ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ | âœ… å®Œå‚™ | 3ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä½œæˆ |

### æ®‹ã£ãŸå•é¡Œï¼ˆå„ªå…ˆåº¦ä½Žï¼‰âš ï¸

| å•é¡Œ | å½±éŸ¿ | å„ªå…ˆåº¦ |
|-----|------|--------|
| NOAA 404ã‚¨ãƒ©ãƒ¼ | E2Eã®ã¿ | ä½Ž |
| å¤–éƒ¨APIä»•æ§˜å¤‰æ›´ | E2Eã®ã¿ | ä½Ž |

**å½±éŸ¿ç¯„å›²**: E2Eãƒ†ã‚¹ãƒˆã®ã¿ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã‚‹ï¼‰

---

## ðŸŽŠ çµè«–

### âœ… ä¿®æ­£å®Œäº†ãƒ»å¯¾ç­–ç¢ºç«‹

1. **DNSå•é¡Œ**: å®Œå…¨è§£æ±º
2. **ãƒ†ã‚¹ãƒˆé«˜é€ŸåŒ–**: 371ç§’ â†’ 20ç§’ï¼ˆ94%å‰Šæ¸›ï¼‰
3. **E2Eå¯¾ç­–**: ãƒžãƒ¼ã‚­ãƒ³ã‚°ãƒ»é™¤å¤–è¨­å®šå®Œäº†
4. **ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ**: å®Œå…¨æ•´å‚™

### âš ï¸ NOAA APIã«ã¤ã„ã¦

- **ç¾çŠ¶**: 404ã‚¨ãƒ©ãƒ¼ï¼ˆå¤–éƒ¨APIå•é¡Œï¼‰
- **å½±éŸ¿**: ãªã—ï¼ˆE2Eãƒ†ã‚¹ãƒˆã®ã¿ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã‚¹ã‚­ãƒƒãƒ—ï¼‰
- **å¯¾ç­–**: ä¸è¦ï¼ˆä»£æ›¿APIå®Ÿè£…æ¸ˆã¿ï¼‰
- **å„ªå…ˆåº¦**: ä½Ž

### ðŸ“‹ æŽ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³

**é–‹ç™ºç¶™ç¶š**:
```bash
pytest  # 20ç§’ã§å®Œäº† âœ…
```

**DNSæ’ä¹…å¯¾ç­–**:
```bash
# /etc/wsl.conf è¨­å®š
[network]
generateResolvConf = false
```

**NOAA APIä¿®æ­£**:
- å¿…è¦ã«å¿œã˜ã¦å°†æ¥å¯¾å¿œ
- ç¾æ™‚ç‚¹ã§ã¯ä¸è¦ï¼ˆä»£æ›¿APIã‚ã‚Šï¼‰

---

**âœ… é–‹ç™ºç’°å¢ƒã¯å®Œå…¨ã«æ­£å¸¸å‹•ä½œã—ã¦ã„ã¾ã™ã€‚è¿½åŠ ã®ä¿®æ­£ä½œæ¥­ã¯ä¸è¦ã§ã™ã€‚**

