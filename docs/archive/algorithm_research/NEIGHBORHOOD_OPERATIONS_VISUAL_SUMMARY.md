# 近傍操作の3次元分類：ビジュアルサマリー

## 最適化の3つの次元

```
       決定変数: x[Field, Crop, Period]
                 │      │      │
                 │      │      └─── いつ？（Period）
                 │      └────────── 何を？（Crop）
                 └───────────────── どこで？（Field）
```

---

## 次元1: 期間の近傍（Period Neighborhood）

**質問**: **いつ栽培するか？**

### 操作の視覚化

```
時間軸: ──────────────────────────────────────────────►
       1月   3月   5月   7月   9月   11月

P1. Shift（シフト）:
  Before: ────[════Rice════]────
              4/1      8/31
  
  After:  ──────[════Rice════]──
                4/15     9/15
          ↑ 2週間シフト

P2. Extend/Shrink（伸縮）:
  Before: ────[════Rice════]────
              4/1      8/31
  
  After:  ────[══════Rice══════]
              4/1          9/30
          ↑ 1ヶ月延長

P3. Split Period（分割）:
  Before: ────[════Rice════]────
              4/1      8/31
  
  After:  ──[═Rice═]──[═Rice═]─
            4/1  6/30 7/1  9/30
          ↑ 2期に分割

P4. Replace（置換）:
  Before: ────[════Rice════]────
              4/1      8/31
  
  After:  ──────────[═Rice═]───
                    5/1   9/30
          ↑ 完全に別の期間

P5. Period Swap（順序入れ替え）:
  Before: [═Rice═]─[Tomato]───
          4/1 8/31 9/1  12/31
  
  After:  [Tomato]─[═Rice═]───
          4/1 7/31 8/1  12/31
          ↑ 栽培順序を入れ替え
```

**効果ランキング**:
1. **P1. Shift**: ⭐⭐⭐⭐⭐ (+5-7%)
2. P2. Extend/Shrink: ⭐⭐⭐☆☆ (+2-3%)
3. P3. Split Period: ⭐⭐☆☆☆ (+1-2%)
4. P4. Replace: ⭐⭐☆☆☆ (+1%)
5. P5. Period Swap: ⭐⭐☆☆☆ (+1%)

---

## 次元2: 圃場の近傍（Field Neighborhood）

**質問**: **どこで栽培するか？**

### 操作の視覚化

```
圃場の配置:
┌─────────┬─────────┬─────────┐
│ Field A │ Field B │ Field C │
│ 1000m²  │ 1500m²  │  800m²  │
│ 5000円/日│ 6000円/日│ 4000円/日│
└─────────┴─────────┴─────────┘

F1. Move（移動）:
  Before:
  ┌─────────┬─────────┬─────────┐
  │ [Rice]  │         │         │
  │ 500m²   │         │         │
  └─────────┴─────────┴─────────┘
  
  After:
  ┌─────────┬─────────┬─────────┐
  │         │         │ [Rice]  │
  │         │         │ 500m²   │ ← より低コスト
  └─────────┴─────────┴─────────┘

F2. Field Swap（交換）:
  Before:
  ┌─────────┬─────────┬─────────┐
  │ [Rice]  │ [Tomato]│         │
  │ 500m²   │ 300m²   │         │
  └─────────┴─────────┴─────────┘
  
  After:
  ┌─────────┬─────────┬─────────┐
  │ [Tomato]│ [Rice]  │         │
  │ 500m²   │ 300m²   │         │
  └─────────┴─────────┴─────────┘
  ↑ 面積等価に数量調整

F3. Field Split（分割利用）:
  Before:
  ┌─────────────────────────────┐
  │        [Rice 4000株]         │
  │         1000m²全体          │
  └─────────────────────────────┘
  
  After:
  ┌──────────────┬──────────────┐
  │  [Rice 2000] │[Tomato 1666] │
  │    500m²     │    500m²     │
  └──────────────┴──────────────┘
  ↑ 同じ圃場を分割

F4. Expand（拡張）:
  Before:
  ┌─────────┬─────────┐
  │ [Rice]  │ [empty] │
  │ 1000m²  │ 1000m²  │
  └─────────┴─────────┘
  
  After:
  ┌───────────────────┐
  │   [Rice 8000株]    │
  │      2000m²       │
  └───────────────────┘
  ↑ 隣接圃場に拡張

F5. Remove（削除）:
  Before:
  ┌─────────┐
  │ [Rice]  │
  │ 500m²   │
  └─────────┘
  
  After:
  ┌─────────┐
  │ [empty] │
  │  0m²    │
  └─────────┘
```

**効果ランキング**:
1. **F2. Field Swap**: ⭐⭐⭐⭐⭐ (+3-5%)
2. F1. Move: ⭐⭐⭐⭐☆ (+2-3%)
3. F3. Field Split: ⭐⭐⭐☆☆ (+2%)
4. F5. Remove: ⭐⭐⭐☆☆ (前処理)
5. F4. Expand: ⭐⭐☆☆☆ (+1%)

---

## 次元3: 作物の近傍（Crop Neighborhood）

**質問**: **何を栽培するか？**

### 操作の視覚化

```
作物の選択肢:
┌─────┬────────┬────────┬────────┐
│     │ Rice   │ Tomato │ Wheat  │
├─────┼────────┼────────┼────────┤
│単位面積│0.25m²  │ 0.3m²  │ 0.2m²  │
│収益性 │50k円/m²│ 60k円/m²│30k円/m²│
└─────┴────────┴────────┴────────┘

C1. Change Crop（作物変更）:
  Before:
  Field A: [🌾 Rice 2000株] (500m²)
  
  After:
  Field A: [🍅 Tomato 1666.67株] (500m²)
           ↑ 同じ面積、作物変更

C2. Crop Swap（作物入れ替え）:
  Before:
  Field A: [🌾 Rice 2000株] (500m²)
  Field B: [🍅 Tomato 1000株] (300m²)
  
  After:
  Field A: [🍅 Tomato 1666.67株] (500m²)
  Field B: [🌾 Rice 1200株] (300m²)
           ↑ 作物を交換

C3. Crop Insert（作物追加）:
  Before:
  Field A: [🌾 Rice] (500m², 500m²空き)
  
  After:
  Field A: [🌾 Rice] 4/1-8/31 (500m²)
          [🍅 Tomato] 9/1-12/31 (300m²)
           ↑ 別の期間に別の作物

C4. Crop Mix（混植）:
  Before:
  Field A: [🌾 Rice 2000株] (500m²)
  
  After:
  Field A: [🌾 Rice 1000株 + 🌽 Wheat 1250株]
           (250m²)       (250m²)
           ↑ 同じ期間に複数作物
```

**効果ランキング**:
1. C3. Crop Insert: ⭐⭐⭐⭐☆ (+2-3%)
2. C1. Change Crop: ⭐⭐⭐⭐☆ (+2%)
3. C2. Crop Swap: ⭐⭐⭐☆☆ (+1-2%)
4. C4. Crop Mix: ⭐⭐☆☆☆ (+1%)

---

## 操作の組み合わせマトリクス

### 単一次元の操作

| 次元 | 操作数 | 効果 | 実装難易度 |
|------|--------|------|-----------|
| **Period** | 5操作 | 最大 | 低～中 |
| **Field** | 5操作 | 中 | 中 |
| **Crop** | 4操作 | 中～小 | 中～高 |

### 複合操作（2次元）

| 組み合わせ | 効果 | 複雑度 | 優先度 |
|-----------|------|--------|--------|
| Period + Field | 高 | 中 | ⭐⭐⭐☆☆ |
| Period + Crop | 中 | 高 | ⭐⭐☆☆☆ |
| Field + Crop | 中 | 高 | ⭐⭐☆☆☆ |

### 複合操作（3次元）

| 組み合わせ | 効果 | 複雑度 | 優先度 |
|-----------|------|--------|--------|
| Period + Field + Crop | 不明 | 非常に高 | ⭐☆☆☆☆ |

---

## 実装戦略

### 戦略A: 次元ごとに段階実装（推奨）

```
Week 1: 期間の近傍（最も効果的）
  └─ P1. Shift

Week 2: 圃場の近傍（次に効果的）
  └─ F1. Move

Week 3: 作物の近傍
  └─ C1. Change Crop
  └─ C3. Crop Insert

Week 4: 複合操作（オプション）
  └─ Period + Field
```

### 戦略B: 効果順に実装

```
1. P1. Shift ⭐⭐⭐⭐⭐ (+5-7%)
2. F2. Field Swap ⭐⭐⭐⭐⭐ (+3-5%) ✅実装済み
3. F1. Move ⭐⭐⭐⭐☆ (+2-3%)
4. C3. Crop Insert ⭐⭐⭐⭐☆ (+2-3%)
5. C1. Change Crop ⭐⭐⭐⭐☆ (+2%)
```

---

## 具体例：3次元の組み合わせ

### 例1: 単一次元の変更

```
Original:
  x[Field A, Rice, 4/1-8/31] = 2000株

Period変更:
  x[Field A, Rice, 4/15-9/15] = 2000株
  
Field変更:
  x[Field B, Rice, 4/1-8/31] = 1200株  # 面積調整
  
Crop変更:
  x[Field A, Tomato, 4/1-8/31] = 1666.67株  # 面積調整
```

### 例2: 2次元の変更

```
Original:
  x[Field A, Rice, 4/1-8/31] = 2000株

Period + Field:
  x[Field B, Rice, 4/15-9/15] = 1200株
  
Field + Crop:
  x[Field B, Tomato, 4/1-8/31] = 1000株
  
Period + Crop:
  x[Field A, Tomato, 5/1-9/30] = 1666.67株
```

### 例3: 3次元の変更

```
Original:
  x[Field A, Rice, 4/1-8/31] = 2000株

Full Change:
  x[Field C, Wheat, 5/1-9/30] = 2000株
  # 圃場、作物、期間すべて変更
```

---

## 次元別の近傍サイズ

### Period（期間）の近傍

```
操作: Shift
候補数: 8個 (±1, ±3, ±7, ±14日)

操作: Replace
候補数: 平均30個（期間候補数）

合計: 約40個/割り当て
```

### Field（圃場）の近傍

```
操作: Move
候補数: F-1個（F=圃場数）
例: 10圃場 → 9個の移動先

操作: Swap
候補数: n-1個（n=割り当て数）
例: 20割り当て → 19個の交換相手

合計: 約30個/割り当て（F=10の場合）
```

### Crop（作物）の近傍

```
操作: Change Crop
候補数: C-1個（C=作物種類数）
例: 5作物 → 4個の代替作物

操作: Crop Insert
候補数: C × P個
例: 5作物 × 30期間 → 150個

合計: 約150個/割り当て（C=5, P=30の場合）
```

---

## 総合的な近傍サイズ

### 1割り当てあたりの近傍数

```
Period: ~40個
Field:  ~30個
Crop:   ~150個
────────────────
合計:   ~220個/割り当て
```

### 全体の近傍数（n=20割り当ての場合）

```
単一操作:
  Period: 20 × 40 = 800個
  Field:  20 × 30 = 600個
  Crop:   20 × 150 = 3,000個
  ─────────────────────────
  合計:   4,400個

複合操作（2次元）:
  Period × Field: 20 × 40 × 30 = 24,000個
  Period × Crop:  20 × 40 × 150 = 120,000個
  Field × Crop:   20 × 30 × 150 = 90,000個
  ───────────────────────────────────
  合計:   234,000個 ← 現実的でない

結論: 単一次元の操作を組み合わせるのが実用的
```

---

## 実装の現状と計画

### 現状（3操作）

| 次元 | 操作 | 状態 |
|------|------|------|
| Field | F2. Field Swap | ✅ 実装済み（面積等価） |
| Field | F5. Remove | ✅ 実装済み |
| Period | P4. Replace | ⚠️ 実装済み（改善が必要） |

**近傍サイズ**: 約50-100個/反復  
**品質**: 85-90%

---

### Phase 1 完了後（+2操作）

| 次元 | 操作 | 追加 |
|------|------|------|
| **Period** | **P1. Shift** | 🆕 最優先 |
| Period | P4. Replace | ⚠️ 改善（3→10候補） |
| Field | F2. Field Swap | ✅ |
| Field | F5. Remove | ✅ |

**近傍サイズ**: 約200-400個/反復  
**品質**: 90-93% (+3-5%)

---

### Phase 2 完了後（+3操作）

| 次元 | 操作 | 追加 |
|------|------|------|
| Period | P1. Shift | ✅ |
| Period | P4. Replace | ✅ |
| **Field** | **F1. Move** | 🆕 |
| Field | F2. Field Swap | ✅ |
| Field | F5. Remove | ✅ |
| **Crop** | **C3. Crop Insert** | 🆕 |
| **Crop** | **C1. Change Crop** | 🆕 |

**近傍サイズ**: 約500-1000個/反復  
**品質**: 92-96% (+2-3%)

---

## 効果の累積予測

```
現状: ████████████████░░░░ 85-90%
      │ F2.Swap │ F5.Remove │ P4.Replace(Limited) │

↓ +P1.Shift (+5-7%)

Phase 1: ███████████████████░ 90-93%
         │ 既存 │ P1.Shift ★★★★★ │

↓ +F1.Move, +C3.Insert, +C1.Change (+2-3%)

Phase 2: █████████████████████ 92-96%
         │ 既存 │ P1 │ F1 │ C3 │ C1 │

↓ 複合操作等 (+1-3%)

Phase 3: ██████████████████████ 95-98%
         │ すべての操作 + 複合操作 │
```

---

## 次元ごとの特徴まとめ

### 期間（Period）の近傍

**特徴**:
- ✅ 最も効果が高い
- ✅ 実装が比較的容易
- ✅ 既存データを活用可能
- ✅ 気象条件に直接影響

**代表操作**: **Shift（シフト）**

**効果**: +5-7%

---

### 圃場（Field）の近傍

**特徴**:
- ✅ コスト構造の最適化
- ✅ 面積制約の考慮が必要
- ⚠️ 面積等価の数量調整が必須

**代表操作**: **Field Swap（圃場交換）**

**効果**: +3-5%

---

### 作物（Crop）の近傍

**特徴**:
- ✅ 市場対応が可能
- ✅ 作物多様性の向上
- ⚠️ 候補数が多い（計算コスト）
- ⚠️ 実装が複雑

**代表操作**: **Crop Insert（作物追加）**

**効果**: +2-4%

---

## 実装の推奨順序

### 📍 Week 1: 期間の最適化

```python
✓ P1. Shift（シフト）
✓ P4. Replace改善（3→10候補）

期待改善: +5-7%
実装工数: 3-4日
```

### 📍 Week 2: 圃場の最適化

```python
✓ F1. Move（移動）
✓ F2. Field Swap（既存、改善の余地あり）

期待改善: +2-3%
実装工数: 4-5日
```

### 📍 Week 3: 作物の最適化

```python
✓ C1. Change Crop（作物変更）
✓ C3. Crop Insert（作物追加）

期待改善: +2-3%
実装工数: 5-6日
```

---

## まとめ

### 3次元の体系的分類

```
           Crop（作物）
            ↑
            │ C1.Change
            │ C2.Swap
            │ C3.Insert
            │
Field ──────●────── Period
（圃場）     │      （期間）
            │
F1.Move     │      P1.Shift ★最重要
F2.Swap     │      P2.Extend
F3.Split    │      P3.Split
F5.Remove   │      P4.Replace
```

### 最重要操作（Top 3）

1. **P1. Shift（期間シフト）**: +5-7% 🔥
2. **F2. Field Swap（圃場交換）**: +3-5% ✅実装済み
3. **F1. Move（圃場移動）**: +2-3%

### 実装の優先順位

```
優先度1: P1. Shift（最重要、今すぐ実装）
優先度2: F1. Move, C3. Crop Insert
優先度3: C1. Change Crop
優先度4: その他の操作
```

この3次元分類により、各操作の役割が明確になり、効率的な実装計画が立てられます！
