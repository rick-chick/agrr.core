## Fertilizer Recommendation (N-P-K) — Design Document

### Goal
Derive crop-specific fertilizer plan using LLM-assisted retrieval and structuring:
- Total N, P2O5, K2O requirements
- Basal vs topdressing split, number of applications, timing
- Output consistent JSON ready for UseCase layer consumption

Unit convention: all nutrient quantities are grams per square meter (g/m2). This is a fixed assumption; `unit_area` is not present in responses.

### Scope (MVP)
- Supported inputs: crop profile file (JSON) generated by CLI command `agrr crop` as the primary input, plus optional target yield, soil type, region, growth period
 - Outputs: totals (N, P2O5, K2O) in g/m2, applications[] with {type: basal|topdress, count, schedule_hint, per_application N/P2O5/K2O in g/m2}
- Data sources: public agronomy guidance; retrieval via existing search adapter; LLM normalizes and justifies figures

### Clean Architecture Mapping
- Entities (domain): `FertilizerPlan`, `FertilizerApplication`
- UseCase: per rule “1クラス1ユースケース”
  - Interactor: `fertilizer_llm_recommend_interactor`
  - Gateway: `fertilizer_llm_recommend_gateway` (LLM + retrieval boundary)
- Adapter:
  - Device: `cli` and `api` may be added later; initial device is `memory` for tests
  - CLI alignment: `agrr fertilize recommend --crop-file <path> [--json] [--output <file>]` (supports `-c`/`-j`/`-o`)

### File/Class Naming
- Interactor: `fertilizer_llm_recommend_interactor.py`
- Gateway: `fertilizer_llm_recommend_gateway.py`
- Controller/adapter examples later: `fertilizer_cli_recommend_controller.py`, etc.

### Data Contracts (UseCase I/O)
Adapter-to-UseCase input: adapter loads a crop profile file (JSON) produced by `agrr crop`, parses it into a `crop_profile` object, and passes it to the interactor. The UseCase must not read files directly.

Request JSON (UseCase input DTO):
```
{
  "crop_profile": { /* exact object produced by `agrr crop` CLI */ }
}
```

Response JSON (UseCase output; units g/m2):
```
{
  "crop": { "crop_id": "tomato", "name": "Tomato" },
  "totals": { "N": 18.0, "P": 5.2, "K": 12.4 },
  "applications": [
    { "type": "basal", "count": 1, "schedule_hint": "pre-plant", "nutrients": { "N": 6.0, "P": 2.0, "K": 3.0 } },
    { "type": "topdress", "count": 2, "schedule_hint": "early fruit set; mid fruiting", "nutrients": { "N": 12.0, "P": 3.2, "K": 9.4 }, "per_application": { "N": 6.0, "P": 1.6, "K": 4.7 } }
  ],
  "sources": ["https://example.org/tomato-fertilizer", "JAガイド 2021 p.12-18"],
  "confidence": 0.7,
  "notes": "Values normalized to g/m2; adjust by soil test"
}
```

Validation Rules
- Units: N, P, K in g/m2; totals.N, totals.P, totals.K ≥ 0
- Application sums must equal totals (± 1e-6) for N, P, K using `application.nutrients.*`
- `applications` must include at least one `basal` or `topdress`
- Optional fields may be null/omitted; defaults documented in adapter

### LLM & Retrieval Strategy
- Retrieval: query agronomy docs by crop + region; prefer government/extension sources
- Prompting: system prompt enforces schema and units (g/m2); ask model to cite sources and perform conversions (e.g., P to P2O5, K to K2O, and per-ha to per-m2) with shown factors
- Determinism: temperature 0–0.2; seed if provider supports; retry on schema violation only (no silent fallbacks)
- Guardrails: strict JSON schema validation; reject and re-ask with validator errors

### Interactor Flow
1) Validate request
2) Ask gateway for recommendation (passes structured query)
3) Validate response schema and invariants
4) Return domain object → adapter serializes

### Gateway Responsibilities
- Build retrieval queries, call search adapter
- Construct LLM prompt with context snippets
- Enforce schema via function/tool calling or JSON schema
- Return structured DTO to interactor; never expose provider details above UseCase layer

### Testing Strategy (doc)
- Unit tests for interactor: happy path, validation errors, schema mismatch handling (using injected fake gateway)
- Adapter integration tests later for real LLM disabled by default; use memory adapter/fixtures
- Mocks in `tests/conftest.py` per rule; no patching

### Entities (Domain Model)
All nutrient values are in g/m2. Nutrients are elemental: N, P, K.

Nutrients
```
{
  "N": number,
  "P": number,
  "K": number
}
```

FertilizerApplication
```
{
  "type": "basal" | "topdress",
  "count": number,
  "schedule_hint": string | null,
  "nutrients": Nutrients,
  "per_application": Nutrients | null
}
```

FertilizerPlan
```
{
  "crop": { "crop_id": string, "name": string },
  "totals": Nutrients,
  "applications": FertilizerApplication[],
  "sources": string[],        // citations or URLs
  "confidence": number,
  "notes": string | null
}
```

Invariants
- totals.N, totals.P, totals.K ≥ 0
- Sum(applications.nutrients.N) == totals.N (± 1e-6), likewise for P and K
- applications[].count ≥ 1
- At least one application exists

### Risks & Constraints
- LLM hallucination: mitigated by retrieval and citation requirements
- Regional variability: parameterize region; allow adapter overrides
- Windows Prophet path limits irrelevant; ensure no heavyweight deps in this feature

### Acceptance Criteria (MVP)
- Given crop input, interactor returns totals and applications that sum correctly
- Response includes at least one application and citations array
- Fails fast on invalid units or negative values

