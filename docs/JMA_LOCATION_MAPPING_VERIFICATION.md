# JMA地点マッピング検証レポート

## 概要
47都道府県の気象庁観測地点マッピング(`LOCATION_MAPPING`)の正確性を検証

## 実施日
2025-10-13

## 検証結果

### ✅ 動作確認済みの地点（E2Eテスト通過）
以下の地点は実際のJMA APIで動作確認済み：

| 地点名 | prec_no | block_no | 状態 |
|--------|---------|----------|------|
| 東京   | 44      | 47662    | ✅ OK |
| 札幌   | 14      | 47412    | ✅ OK |
| 大阪   | 62      | 47772    | ✅ OK |

### ⚠️ 検証が必要な地点

#### 1. prec_no重複（正常な可能性あり）
prec_noは「地域区分番号」のため、同一地域内の複数地点が同じprec_noを持つことは正常：

| prec_no | 地点 | 理由 |
|---------|------|------|
| 42 | 前橋、熊谷 | ただし熊谷は埼玉県なので要確認 |
| 61 | 大津、京都 | 近畿地方の地域区分として正常 |
| 66 | 岡山、広島 | 中国地方の地域区分として正常 |

#### 2. 疑わしい地点コード

##### 埼玉県（熊谷）
- **現状**: `prec_no=42, block_no=47626, "熊谷"`
- **問題**: prec_no=42は群馬地方の可能性
- **対応**: 埼玉県の正式な県庁所在地「さいたま市」の地点コードを確認

##### その他の地点
以下の地点は目視確認が推奨される：
- 千葉 (45, 47682)
- 滋賀 (61, 47761, "大津")  
- 京都 (61, 47759, "京都")
- 岡山 (66, 47768)
- 広島 (66, 47765)

## JMAの地点コード体系

### prec_no（地域番号）
- 都道府県単位ではなく、地域区分単位
- 同一地域内に複数の観測地点が存在可能
- 例: 近畿地方（prec_no=61）に大津と京都が含まれる

### block_no（地点番号）
- 各観測地点を一意に識別
- 5桁の数値（例：47662）

## 推奨対応

### 1. 優先度：高
公式な地点リストとの照合が必要：
- [ ] 埼玉県の正しい代表地点コードを確認
- [ ] 熊谷が埼玉県の代表地点として適切か確認

### 2. 優先度：中
- [ ] 47都道府県すべての地点コードをJMA公式リストと照合
- [ ] 各県の県庁所在地または主要気象台の正確な座標を確認

### 3. 優先度：低
- [ ] block_noからprec_noを動的に取得する機能の追加
- [ ] JMA APIで地点リストを取得する機能の追加

## 参考リソース

### JMA公式情報
- 地点一覧: https://www.data.jma.go.jp/stats/mdrr/chiten/sindex2.html
- データ取得URL形式:
  ```
  https://www.data.jma.go.jp/obd/stats/etrn/view/daily_s1.php?
  prec_no={prec_no}&block_no={block_no}&year={year}&month={month}&day=&view=
  ```

### テスト確認方法
```bash
# 単体テスト
pytest tests/test_adapter/test_weather_jma_repository.py -v

# E2Eテスト（実際のJMA APIにアクセス）
pytest tests/test_e2e/test_weather_jma_real.py -v -m e2e
```

## 現在の運用状況

### ✅ 動作可能
- 最近傍探索により、ユーザー指定座標から最も近い観測地点を自動選択
- 主要11地点（動作確認済み）は問題なく動作
- 47地点すべてがマッピングされている

### ⚠️ 潜在的な問題
- 一部の地点コードが正しくない可能性
- prec_noの重複は正常だが、block_noの正確性は未検証
- 県庁所在地ではない地点が選択されている可能性（例：埼玉→熊谷）

## 結論

**現状**: 基本機能は動作するが、地点コードの正確性に関する完全な検証が必要

**推奨**: 
1. JMA公式リストとの照合を実施
2. 疑わしい地点（特に埼玉県）を優先的に修正
3. E2Eテストで主要地点の動作を継続的に確認

## 検証結果（E2Eテスト実施済み）

### ❌ 動作しない地点コード（確認済み）
| 地点名 | prec_no | block_no | 状態 | 検証日 |
|--------|---------|----------|------|--------|
| 熊谷（埼玉） | 42 | 47626 | ❌ データ取得失敗 | 2025-10-13 |

**エラー内容**: `No tables found in HTML` - 該当する地点コードでJMAからデータが返されない

### 埼玉県の候補コード
以下のURLで手動確認が必要：
1. `prec_no=43, block_no=47626` (推奨度: 高)
2. `prec_no=43, block_no=47624`
3. `prec_no=43, block_no=47629`

## 推奨対応方針

### アプローチ1: 段階的修正（推奨）
1. ✅ **動作確認済みの地点のみを残す**（東京、札幌、大阪など主要11地点）
2. 疑わしい地点は一旦削除またはコメントアウト
3. JMA公式サイトで確認後、段階的に地点を追加
4. 各地点追加時にE2Eテストで動作確認

### アプローチ2: 完全調査（時間要）
1. JMA公式サイトの地点選択UIから47都道府県すべての地点コードを手動で取得
2. 一括で修正してE2Eテスト実行
3. 失敗した地点を個別に修正

## 次のアクション

### 即座に実施すべき
- [x] E2Eテストで埼玉県の地点コードが誤りであることを確認（完了）
- [ ] 埼玉県の地点コードを修正または一旦削除
- [ ] 動作確認済みの主要地点のみを残す設定に変更

### 中期的に実施
- [ ] JMA公式サイトから47都道府県の正式な地点コードリストを取得
  - 方法: https://www.data.jma.go.jp/stats/data/mdrr/chiten/sindex2.html で地点を選択し、URLを確認
- [ ] `LOCATION_MAPPING`の全地点を公式リストと照合
- [ ] 誤りが見つかった地点を修正
- [ ] E2Eテストで修正後の動作を確認

### 長期的に検討
- [ ] JMA APIから地点リストを動的に取得する機能の実装
- [ ] block_noからprec_noを自動推定するロジックの追加

